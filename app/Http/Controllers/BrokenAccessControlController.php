<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Session;

class BrokenAccessControlController extends Controller
{
    public function showNote(Request $request)
    {
        $userId = Session::get('user_id'); // Lấy user_id từ session
        $userName = Session::get('user_name'); // Lấy tên người dùng từ session

        if (!$userId) {
            return redirect('/login'); // Nếu không có user_id, chuyển hướng đến trang đăng nhập
        }

        // Truy vấn để lấy ghi chú công khai và ghi chú của người dùng
        $result = DB::select("
            SELECT * 
            FROM note 
            WHERE isSecret = 0 OR Author = (SELECT name FROM users WHERE ID = ?)", 
            [$userId]
        );

        return view('brac')->with('result', $result);
    }

    public function insertNote(Request $request)
    {
        $postName = $request->input('postName');
        $author = Session::get('user_name'); // Lấy tên tác giả từ session
        $isSecret = $request->input('isSecret');
        $content = $request->input('content');

        DB::insert('INSERT INTO note (postName, Author, isSecret, Content) VALUES (?, ?, ?, ?)', [
            $postName,
            $author,
            $isSecret,
            $content
        ]);

        return redirect('/brac'); // Chuyển hướng đến trang ghi chú sau khi thêm thành công
    }

    public function showSpecificNote($PostID)
    {
        $userId = Session::get('user_id'); // Lấy user_id từ session
        $userName = Session::get('user_name'); // Lấy tên người dùng từ session

        if (!$userId) {
            return redirect('/login'); // Nếu không có user_id, chuyển hướng đến trang đăng nhập
        }

        // Lấy thông tin của ghi chú
        $result = DB::select("SELECT * FROM note WHERE PostID = ?", [$PostID]);

        // Kiểm tra xem ghi chú có phải của người dùng không
        if ($result && $result[0]->isSecret == 1 && $result[0]->Author !== $userName) {
            return redirect('/brac')->with('error', 'You do not have permission to view this note.'); // Nếu không phải của người dùng, chuyển hướng
        }

        return view('brac_specific_note')->with('result', $result);
    }
}
